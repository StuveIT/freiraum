---
import Card from './Card.astro';
import Item from './toolbar/Item.astro';
---

<Card>
  <Item slot="toolbar" onclick="console.log('Timeline')"}>Timeline</Item>
    <Item slot="toolbar" onclick="console.log('Karte')">Karte</Item>

    <div id="content" slot="body">
    </div>
</Card>
  
<script type="module" is:inline>
  import { fetchAvailable } from '/js/room_events.js';
  import { TimelineUI } from "/js/timeline.js";
  import { GeoUI } from "/js/geo.js";
  
  const content_elem = document.getElementById("content");
  const timeline = new TimelineUI();
  const geo = new GeoUI();

  function displayUnreachable() {
    content_elem.innerHTML = `⚠️ Dein Browser konnte keine Anfrage an <a href="134.34.26.182">RoomRes</a> stellen. Das kann folgende Gründe haben: 
    <ul>
      <li>Du bist nicht im Uni-Netz. Falls du dich nicht an der Uni Konstanz aufhälst, kannst du ein VPN benutzen (Siehe: <a href="https://www.kim.uni-konstanz.de/e-mail-und-internet/eduvpn/">KIM Website</a>)</li>
      <li>Dein Browser upgraded deine HTTP Verbindung zu HTTPS. RoomRes ist gerade nur unter dem HTTP Protokoll erreichbar --- wir arbeiten mit dem KIM zusammen, um das zu verbessern</li>
      <li>RoomRes ist gerade nicht erreichbar</li>
    </ul>`;
  }

  function display(...elems) {
    const now = new Date();

    const date_picker = document.createElement('input');
    date_picker.style = "width: 100%";
    date_picker.type = "date";
    date_picker.id = "date-picker";
    date_picker.valueAsNumber = Date.now();
    
    content_elem.appendChild(date_picker);
    elems.forEach(elem => content_elem.appendChild(elem))
  }

  function update(new_date) {
    fetchAvailable(new_date).then(roomsWithEvents => {
      display(timeline.display(roomsWithEvents));
      setInterval(timeline.updateIndicator, 60000);
      geo.display(roomsWithEvents);
    }).catch((error) => {
      console.error(error);
      displayUnreachable();
    });
  }
  update();
</script>
